// test_gru.cpp
// Test GRU module

#define DOCTEST_CONFIG_IMPLEMENT_WITH_MAIN
#include <tt/device.h>
#include <tt/exception.h>
#include <tt/index.h>
#include <tt/nn/gru.h>
#include <tt/scalar.h>
#include <tt/shape.h>
#include <tt/tensor.h>

#include "doctest.h"
#include "test_util.h"

#include <cmath>
#include <memory>
#include <vector>

using namespace tinytensor;

// NOLINTNEXTLINE
TEST_CASE("GRU shapes") {
    auto device = kCPU;
    const int L = 3;
    const int B = 5;
    const int input_size = 10;
    const int hidden_size = 4;
    {
        int num_layers = 2;
        nn::GRU gru(input_size, hidden_size, nn::GRUOptions{.num_layers = num_layers}, kF64, device);
        Tensor x = uniform_real(0, 1, {L, input_size});
        Tensor h = uniform_real(0, 1, {num_layers, hidden_size});
        auto output = gru.forward(x, h);
        CHECK_EQ(output.output.shape(), Shape{L, hidden_size});
        CHECK_EQ(output.h.shape(), Shape{num_layers, hidden_size});
    }
    {
        int num_layers = 2;
        nn::GRU
            gru(input_size, hidden_size, nn::GRUOptions{.num_layers = num_layers, .bidirectional = true}, kF64, device);
        Tensor x = uniform_real(0, 1, {L, input_size});
        Tensor h = uniform_real(0, 1, {2 * num_layers, input_size});
        auto output = gru.forward(x);
        CHECK_EQ(output.output.shape(), Shape{L, 2 * hidden_size});
        CHECK_EQ(output.h.shape(), Shape{2 * num_layers, hidden_size});
    }
    {
        int num_layers = 2;
        nn::GRU gru(
            input_size,
            hidden_size,
            nn::GRUOptions{.num_layers = num_layers, .batch_first = true, .bidirectional = true},
            kF64,
            device
        );
        Tensor x = uniform_real(0, 1, {B, L, input_size});
        auto output = gru.forward(x);
        CHECK_EQ(output.output.shape(), Shape{B, L, 2 * hidden_size});
        CHECK_EQ(output.h.shape(), Shape{2 * num_layers, B, hidden_size});
    }
}

// NOLINTNEXTLINE
TEST_CASE("GRU bi-directional backward") {
    auto device = kCPU;
    nn::GRU gru(10, 4, nn::GRUOptions{.num_layers = 2, .bidirectional = true}, kF64, device);
    Tensor w_ih_0(
        std::vector<double>{-0.1653460073, -0.4470132651, -0.2432873734, 0.2473962305,  -0.4549354759, 0.4893608312,
                            0.4911974037,  0.3809338586,  0.4238157374,  -0.2747345131, -0.2502348877, -0.2108065086,
                            -0.1965248476, -0.4359421894, 0.0161723891,  0.2455951910,  -0.3147714987, -0.2856705235,
                            -0.4937317016, -0.4374408476, -0.0332001829, 0.0172102226,  -0.1473195056, -0.2747659203,
                            -0.2766866730, 0.3235798371,  -0.1194619779, 0.3834449808,  -0.1940912287, -0.3156351445,
                            -0.0458598014, -0.1577219025, 0.3969919053,  -0.0415086350, 0.4785357414,  -0.2336714953,
                            -0.3424091111, -0.2133933876, -0.2270488199, -0.4976355000, -0.2989302507, -0.2907866305,
                            -0.4084885257, 0.2514492390,  0.4806422689,  0.1783085368,  -0.0419765006, -0.4899587532,
                            -0.1793059136, -0.4966359837, 0.3338202680,  -0.0916231019, -0.0360239296, -0.2963773274,
                            -0.1615782548, 0.0181326065,  -0.1156574327, 0.3785943740,  -0.1801459018, 0.4830274038,
                            0.1233693274,  0.4499640755,  0.2682301052,  0.0830562275,  0.3538465559,  0.2392412797,
                            -0.3700521640, 0.2566953814,  -0.2302396049, 0.1793544157,  0.3596309339,  -0.1640334679,
                            0.1540014197,  0.1807643604,  -0.0479391824, 0.1824391722,  -0.3832264756, -0.4306095112,
                            -0.2375417880, 0.4978603100,  0.2897684062,  -0.4452956746, 0.1149172236,  0.1217811327,
                            0.4742150059,  -0.1348852413, -0.3711679673, -0.1510460787, 0.2270866352,  -0.4239760261,
                            -0.2585260589, 0.2883103310,  0.2341319483,  0.1332915000,  -0.1504092871, 0.2843158822,
                            0.2938705127,  0.2042120691,  -0.3303883202, -0.4795333133, -0.0968149901, -0.0666842429,
                            0.4232751997,  -0.2507890235, 0.4376838744,  -0.1512260527, 0.0150922920,  -0.1702062565,
                            -0.2713388253, -0.1845553246, 0.4038665550,  0.0012512960,  -0.4631597549, 0.3316543370,
                            -0.2232212087, -0.0311618444, 0.0683212032,  -0.1027889861, 0.4102127651,  0.2076342417},
        {12, 10},
        device,
        true
    );
    Tensor w_ih_1(
        std::vector<double>{-0.4272009239, -0.2437918621, -0.0496534164, -0.2670952334, 0.0619077439,  -0.3890100534,
                            -0.3621252057, 0.3268609309,  0.1264686303,  0.1644691017,  0.3709762458,  0.3394069037,
                            -0.4514451379, 0.3867323223,  -0.0485394789, -0.4337081973, -0.0620073642, -0.0526179255,
                            -0.4359773335, 0.0849914455,  -0.4265055443, -0.4289073785, -0.0586627580, -0.2696081662,
                            0.4971921795,  0.4950090557,  -0.3336667261, -0.1898924481, 0.1028289904,  -0.0058853996,
                            -0.2863523580, 0.2004199489,  -0.1620405531, 0.3369664855,  -0.2743838969, -0.4838909533,
                            0.2696237455,  0.3431815577,  -0.2784113704, 0.4008997661,  -0.2937102636, -0.4491007473,
                            0.1432386421,  -0.2352588652, 0.3853992923,  0.1170374738,  0.1994952625,  0.3312654393,
                            -0.2177859115, -0.3205330353, 0.3453009492,  -0.4873023612, 0.3989172908,  -0.0972750543,
                            -0.4914575810, -0.4592297431, 0.0321055036,  -0.2543396832, 0.3057713093,  0.3183849598,
                            0.2003287323,  0.0730366305,  -0.2280588586, -0.3475939507, -0.4799528713, -0.1756945406,
                            0.4707168657,  -0.0177231038, -0.3541000440, 0.3434000804,  0.4020647643,  0.4672292988,
                            -0.3897992236, 0.2468458834,  -0.3891404172, -0.1831683050, -0.0599119602, 0.1415704084,
                            -0.2098395690, 0.0443999144,  0.3100595575,  -0.1898021685, 0.3208134923,  0.4608474900,
                            -0.4591557964, 0.1051653479,  -0.4247784029, 0.2978351523,  0.4206989997,  -0.1097274197,
                            0.2321865441,  0.3888135798,  -0.3329618909, -0.2459154798, -0.3991491773, 0.4742002548},
        {12, 8},
        device,
        true
    );
    Tensor w_ih_0_reverse(
        std::vector<double>{0.2449375358,  0.0180740817,  0.4645960912,  0.4835838439,  0.3466721206,  0.4683020780,
                            0.3295841309,  -0.0543898911, 0.1891222344,  -0.2979367967, 0.3854035211,  0.3037583053,
                            -0.0945433602, 0.4445708830,  -0.1904017402, 0.2229577282,  0.2848939000,  -0.4834745275,
                            0.1029661531,  0.3325448612,  -0.1162256999, 0.0638236144,  0.4863088853,  0.3665972607,
                            0.2321371949,  0.0299157074,  0.2987092692,  0.3479044199,  0.2852759279,  0.4637520290,
                            -0.4369383895, -0.0753676365, -0.1212058201, -0.2160303510, -0.1246284424, 0.0260944335,
                            -0.4005816191, -0.1954101704, -0.3221189336, 0.3544027683,  -0.1005580468, 0.3811397494,
                            0.2540175819,  0.3670937562,  0.3721579256,  -0.4441436791, -0.1122910426, 0.1169946784,
                            0.0882258744,  -0.1830341804, 0.4490330023,  -0.0680620359, 0.0661119762,  -0.4561515363,
                            0.3563394918,  0.1750704192,  0.0694711012,  0.2228444842,  -0.2794115936, -0.0712168590,
                            -0.2800120359, -0.0167173472, -0.2787816090, 0.4766346118,  0.2476170543,  0.3596019402,
                            0.4878975032,  0.1690171360,  0.0347344684,  -0.2662712672, -0.0652261597, 0.2218258129,
                            0.0933932870,  0.1764851865,  0.0015473512,  0.0771233523,  -0.3730958587, 0.2884920102,
                            0.1857908792,  0.1035234336,  -0.3107204053, 0.1254599745,  -0.2105646045, 0.3959133340,
                            -0.1380958744, -0.4848521160, -0.0734060192, 0.0767820249,  0.4558781466,  0.2462610530,
                            -0.4858967194, 0.1840003693,  0.2819005038,  -0.0746757292, 0.1766983509,  0.3736477479,
                            0.2766458282,  0.2169636827,  -0.4414662242, -0.2994806538, -0.4689191556, -0.2944690375,
                            -0.0675929822, -0.4173061030, 0.0325116097,  0.4562912201,  0.3531328088,  0.0410528554,
                            -0.4812726204, 0.2245486503,  0.3571830072,  -0.2420103995, -0.4674868206, -0.2806816053,
                            -0.4802287781, -0.1533038789, 0.0010530883,  0.2650504699,  0.2607624779,  -0.2996498852},
        {12, 10},
        device,
        true
    );
    Tensor w_ih_1_reverse(
        std::vector<double>{0.3398292520,  -0.2111074394, -0.4163795371, 0.3545144187,  -0.2493367037, 0.1490883194,
                            0.4514867862,  -0.4637352839, -0.1698108903, -0.3323235419, -0.3269017542, -0.0756860299,
                            0.3264796502,  0.3265198753,  -0.4115356607, 0.1810630245,  -0.0348929930, -0.1200128696,
                            0.1673461615,  0.4392250479,  -0.0921616362, -0.4092869202, 0.2852281326,  -0.2807178083,
                            -0.3313672558, 0.1406576580,  0.4396580973,  0.4164705322,  0.0116739546,  0.4052117669,
                            -0.0373937118, 0.4944880278,  0.4404868141,  0.4331212834,  -0.2231911812, -0.1481016058,
                            0.4448780767,  -0.1516809120, -0.4069740829, 0.1838050695,  -0.2653390272, -0.1295111571,
                            -0.0181866041, -0.3693739399, -0.4608225387, 0.3440391702,  -0.1838711935, 0.2901353383,
                            0.0173209515,  -0.0811369809, 0.3642292489,  -0.1325157510, -0.3136663709, 0.0573851442,
                            0.2191113738,  0.2635096741,  -0.0667699868, 0.2308779295,  -0.1493216210, -0.0086031454,
                            -0.3734702335, -0.4458774004, -0.1412356631, 0.2677303936,  0.3893925931,  -0.1248831235,
                            0.2098237701,  0.3371449617,  0.0454529583,  0.1666753163,  0.0498827221,  0.2622117388,
                            -0.2796754991, 0.1710326900,  0.1987753194,  -0.3620315299, 0.0239049919,  0.2248721734,
                            0.2643343224,  -0.2001069476, -0.3962382280, -0.0200007751, -0.1880124196, -0.1023914048,
                            0.4602004110,  -0.2682183787, -0.3657267749, 0.1897617849,  -0.0224368201, 0.4105540915,
                            0.2701630284,  0.0350871806,  0.2693997797,  0.1338745344,  -0.1126477255, -0.4619653585},
        {12, 8},
        device,
        true
    );
    Tensor w_hh_0(
        std::vector<double>{-0.0963381357, 0.0230802056,  -0.3185986349, 0.3763912732,  0.2090452590,  -0.3183167988,
                            0.3713430719,  -0.4536398502, -0.3098313030, 0.1549541321,  0.0218465567,  0.4428296687,
                            0.0455173444,  -0.3651444072, -0.1546283999, -0.4988150801, -0.3011675128, -0.2273761264,
                            0.0696301174,  0.0108228756,  -0.2327720114, -0.1929554715, 0.3281034972,  -0.0488554614,
                            0.2545765955,  0.4498618168,  0.2470608860,  0.2981834640,  0.0879527935,  -0.4564294227,
                            0.4668493947,  -0.0797515103, -0.2844935260, 0.3296256823,  0.1475693088,  0.3366267421,
                            -0.0326922208, -0.3054658250, 0.0915555180,  -0.1099454012, 0.0598651559,  -0.4862068150,
                            0.1476861972,  -0.2822930415, 0.2390956605,  0.2847645518,  0.0608435808,  0.3779498004},
        {12, 4},
        device,
        true
    );
    Tensor w_hh_1(
        std::vector<double>{0.2713295837,  -0.3640728912, -0.2911141104, 0.1171474575,  0.3067699816,  0.2729427817,
                            0.3890180981,  -0.0794827760, -0.1082104152, 0.0059650591,  0.3849838942,  0.2967187163,
                            0.3199028208,  0.2025226404,  0.2564435815,  0.1055991402,  -0.1203477988, 0.1599422491,
                            -0.4503315852, 0.3264209561,  -0.3463991713, -0.0647598710, -0.4579917315, -0.1276426219,
                            -0.3965008317, -0.0011505798, 0.3302429352,  0.2773809898,  -0.3394395265, -0.2770444361,
                            0.4327056105,  -0.3484620529, -0.2672707707, 0.1723013795,  -0.0912396573, 0.0707237123,
                            0.2960048040,  -0.2380872649, 0.1719160408,  -0.3415629031, 0.4879819585,  0.0434344122,
                            -0.3295391383, -0.4684679093, 0.4227871849,  -0.4862938643, 0.2992122590,  0.4107665471},
        {12, 4},
        device,
        true
    );
    Tensor w_hh_0_reverse(
        std::vector<double>{0.2613261233,  -0.0104343507, 0.0704950936,  0.2502645410,  -0.1466275037, 0.0821196270,
                            0.1461105750,  0.2572346584,  0.3386871384,  -0.2019355936, 0.2279375091,  0.2855764949,
                            0.1250841594,  -0.0239416658, -0.4124522737, 0.4477266385,  -0.2289778635, -0.1441413886,
                            -0.1655632341, 0.2180199614,  -0.2461616273, -0.1112330460, -0.2417919537, 0.2760375894,
                            0.4434855297,  -0.3966922332, -0.1083812042, 0.4390628089,  0.2506104446,  0.2974137714,
                            -0.2402603386, 0.3716980503,  0.0843359554,  0.0835497372,  0.0461237405,  -0.1374766857,
                            0.1633342134,  -0.1016087532, -0.4673081547, 0.3424514054,  -0.3994756360, -0.1169114519,
                            0.0659352914,  -0.0593730652, 0.4949954080,  0.3045110086,  -0.2754740062, -0.4970862868},
        {12, 4},
        device,
        true
    );
    Tensor w_hh_1_reverse(
        std::vector<double>{0.1040454912,  0.4872082089,  -0.0501169026, 0.1235863764,  -0.1706424434, 0.3514912661,
                            -0.0793629616, -0.2768354047, -0.2223992928, -0.1831425156, 0.1769804969,  -0.3370383576,
                            -0.3855235698, 0.3960925594,  -0.2695947167, -0.4950804721, 0.3743856524,  -0.0479266328,
                            -0.0246613099, -0.0909916941, -0.4356363872, 0.1100424426,  0.0557088452,  -0.4443653260,
                            -0.4422836300, 0.1426079409,  0.2057382728,  0.3825550843,  0.0642680578,  0.1521354314,
                            -0.2851354131, 0.4760594145,  0.1243900188,  0.3466800374,  0.2928594807,  -0.3673204122,
                            0.4079076464,  0.2501640605,  0.4196006472,  0.2069317300,  -0.3961538659, 0.3933515933,
                            -0.0494378852, -0.3563231397, -0.4938783588, 0.1893711959,  -0.4642770632, -0.4952094103},
        {12, 4},
        device,
        true
    );
    Tensor b_ih_0(
        std::vector<double>{
            0.1599464620,
            0.3646760281,
            0.0655232513,
            0.1057925831,
            -0.1557366375,
            0.0125811371,
            0.2445296320,
            -0.1390686604,
            -0.3790431529,
            0.4610698697,
            0.1943055658,
            0.4411720978
        },
        {12},
        device,
        true
    );
    Tensor b_ih_1(
        std::vector<double>{
            0.0252629307,
            -0.2106752130,
            0.3274318718,
            -0.1238595889,
            0.1085065719,
            0.1665648513,
            0.4008563921,
            0.3041967561,
            -0.3334080787,
            0.4627475584,
            0.0395295459,
            0.1964966262
        },
        {12},
        device,
        true
    );
    Tensor b_ih_0_reverse(
        std::vector<double>{
            -0.0524887748,
            -0.0710406803,
            0.4493215072,
            0.0299739990,
            0.2853483580,
            0.0992256522,
            0.3424156297,
            0.4410774711,
            -0.3307564045,
            -0.1368870815,
            -0.0166936155,
            0.1357424873
        },
        {12},
        device,
        true
    );
    Tensor b_ih_1_reverse(
        std::vector<double>{
            -0.4634131994,
            -0.0464399775,
            -0.1546769234,
            0.0019396671,
            -0.4679124840,
            -0.2896791103,
            -0.3089533335,
            0.2341645666,
            0.0669126916,
            0.4275886430,
            -0.0455738377,
            -0.3440503216
        },
        {12},
        device,
        true
    );
    Tensor b_hh_0(
        std::vector<double>{
            -0.1448271462,
            0.3450114198,
            -0.0791735876,
            -0.2888960451,
            -0.4149523055,
            0.0656191459,
            0.3968688444,
            0.2727322461,
            0.1958953421,
            0.2291051876,
            -0.2813451722,
            -0.2994055838
        },
        {12},
        device,
        true
    );
    Tensor b_hh_1(
        std::vector<double>{
            -0.2309306890,
            0.0249980478,
            -0.3398841556,
            -0.4965588960,
            0.0432729238,
            0.4045648928,
            0.4046127875,
            -0.3972611717,
            -0.3306746063,
            0.3110360820,
            -0.4019198019,
            0.0214830145
        },
        {12},
        device,
        true
    );
    Tensor b_hh_0_reverse(
        std::vector<double>{
            -0.4629212245,
            -0.3248217313,
            -0.2474359684,
            0.3797655963,
            0.2670206664,
            0.1253096914,
            -0.2007279821,
            -0.1789627245,
            -0.2068728069,
            -0.0304247852,
            0.3098704909,
            0.3948990838
        },
        {12},
        device,
        true
    );
    Tensor b_hh_1_reverse(
        std::vector<double>{
            0.2585564119,
            0.0752576829,
            0.3977870328,
            0.1534024131,
            0.2769167066,
            -0.4248804412,
            0.2644503079,
            -0.1981211079,
            -0.2362230248,
            -0.0868167590,
            -0.4178648236,
            -0.3544240602
        },
        {12},
        device,
        true
    );
    gru.weights_ih.clear();
    gru.weights_ih.push_back(std::make_shared<Tensor>(w_ih_0.permute({1, 0})));
    gru.weights_ih.push_back(std::make_shared<Tensor>(w_ih_1.permute({1, 0})));
    gru.weights_ih_reverse.clear();
    gru.weights_ih_reverse.push_back(std::make_shared<Tensor>(w_ih_0_reverse.permute({1, 0})));
    gru.weights_ih_reverse.push_back(std::make_shared<Tensor>(w_ih_1_reverse.permute({1, 0})));
    gru.weights_hh.clear();
    gru.weights_hh.push_back(std::make_shared<Tensor>(w_hh_0.permute({1, 0})));
    gru.weights_hh.push_back(std::make_shared<Tensor>(w_hh_1.permute({1, 0})));
    gru.weights_hh_reverse.clear();
    gru.weights_hh_reverse.push_back(std::make_shared<Tensor>(w_hh_0_reverse.permute({1, 0})));
    gru.weights_hh_reverse.push_back(std::make_shared<Tensor>(w_hh_1_reverse.permute({1, 0})));
    gru.biases_ih.clear();
    gru.biases_ih.push_back(std::make_shared<Tensor>(b_ih_0));
    gru.biases_ih.push_back(std::make_shared<Tensor>(b_ih_1));
    gru.biases_ih_reverse.clear();
    gru.biases_ih_reverse.push_back(std::make_shared<Tensor>(b_ih_0_reverse));
    gru.biases_ih_reverse.push_back(std::make_shared<Tensor>(b_ih_1_reverse));
    gru.biases_hh.clear();
    gru.biases_hh.push_back(std::make_shared<Tensor>(b_hh_0));
    gru.biases_hh.push_back(std::make_shared<Tensor>(b_hh_1));
    gru.biases_hh_reverse.clear();
    gru.biases_hh_reverse.push_back(std::make_shared<Tensor>(b_hh_0_reverse));
    gru.biases_hh_reverse.push_back(std::make_shared<Tensor>(b_hh_1_reverse));
    Tensor x(
        std::vector<double>{0.6740, 0.4387, 0.4062, 0.1206, 0.2623, 0.9856, 0.4026, 0.7337, 0.3350, 0.5235,
                            0.2460, 0.8684, 0.7513, 0.0892, 0.3925, 0.7514, 0.3249, 0.0602, 0.2559, 0.6123,
                            0.6633, 0.3466, 0.3223, 0.3817, 0.2039, 0.7021, 0.1770, 0.6562, 0.3099, 0.7529,
                            0.9963, 0.5240, 0.5245, 0.1268, 0.0018, 0.0400, 0.4644, 0.3876, 0.7429, 0.0459,
                            0.5863, 0.5081, 0.2374, 0.0294, 0.7231, 0.2279, 0.0397, 0.0282, 0.1430, 0.0408,
                            0.3739, 0.9591, 0.3888, 0.5413, 0.1339, 0.4381, 0.0708, 0.1158, 0.8383, 0.3166,
                            0.4505, 0.7202, 0.1996, 0.2101, 0.4820, 0.7354, 0.5231, 0.2774, 0.7259, 0.7304,
                            0.2147, 0.3757, 0.0831, 0.3947, 0.8909, 0.7151, 0.1722, 0.7647, 0.5780, 0.7381,
                            0.5978, 0.6705, 0.1593, 0.8128, 0.1489, 0.2154, 0.3307, 0.1552, 0.0384, 0.5879,
                            0.0780, 0.7179, 0.8744, 0.8581, 0.4695, 0.5068, 0.5592, 0.1436, 0.5107, 0.4588},
        {2, 5, 10},
        device
    );

    Tensor expected_output(
        std::vector<double>{-0.1281277413, 0.2710348751,  -0.0458740859, 0.1067601540,  -0.1165509413, 0.3037640142,
                            -0.0955343407, -0.2780827795, -0.1040224309, 0.2752153629,  -0.1066153195, -0.0433143666,
                            -0.1898430417, 0.4372065040,  -0.1658901837, -0.2092488500, -0.1390409617, 0.2521600095,
                            -0.0681296798, 0.0780005260,  -0.1047502259, 0.3220008833,  -0.1527624536, -0.2888844620,
                            -0.2392176782, 0.2603694043,  0.0321527461,  0.2572156502,  -0.0401886688, 0.1615687537,
                            -0.0432727512, -0.2810510678, -0.2229641396, 0.2500885066,  -0.0092122737, 0.1454452968,
                            -0.0530364914, 0.3448382046,  -0.2144547974, -0.1816130376, -0.2931627022, 0.4235973651,
                            -0.0814367851, 0.1734906948,  -0.0671542624, 0.1806027386,  -0.0495381512, -0.1652677267,
                            -0.1895708111, 0.4206790789,  -0.1355458418, 0.0123826870,  -0.1016733570, 0.2733666400,
                            -0.1094675244, -0.1807051373, -0.2443352618, 0.3806353537,  -0.1118128211, 0.1010471053,
                            -0.0486240610, 0.2379309669,  -0.1545432441, -0.2014196280, -0.3173883097, 0.4046536519,
                            -0.0653051361, 0.2254106961,  -0.0754951155, 0.2078156334,  -0.0817427906, -0.1733685740,
                            -0.2872655721, 0.4036496775,  -0.0995575720, 0.0643208979,  -0.0878215393, 0.3319186215,
                            -0.1551326697, -0.1013002011},
        {2, 5, 8},
        device
    );

    Tensor expected_w_ih_0_grad(
        std::vector<double>{-0.0373597147, 0.0202878160,  -0.0806398073, -0.0214476479, -0.0166577358, -0.1462089081,
                            0.1248371960,  -0.1324977876, -0.4618721903, 0.4359659981,  1.0133350551,  0.3217155826,
                            -0.0584966902, 0.0221485853,  -0.0929612042, -0.0250440141, -0.0155812492, -0.1681117184,
                            0.1018231624,  -0.1139577484, -0.6181086486, 0.5348819626,  1.0685842761,  0.3809762295,
                            -0.0275415619, 0.0143206078,  -0.0614045185, -0.0196725604, -0.0170948672, -0.1255547751,
                            0.0539652343,  -0.0915935712, -0.3332286488, 0.3201572743,  0.7652869894,  0.3033098730,
                            -0.0423039683, 0.0112979049,  -0.0503843076, -0.0069531219, -0.0179095688, -0.0871938620,
                            0.0999481593,  -0.0487562494, -0.4289543482, 0.3115684041,  0.5124398154,  0.1235381777,
                            -0.0314408462, 0.0134110686,  -0.0549603645, -0.0177236991, -0.0014145338, -0.0920597611,
                            0.0221500393,  -0.0718666048, -0.3363611146, 0.3120316345,  0.6299849540,  0.2681296784,
                            -0.0408867633, 0.0170038630,  -0.0800620980, -0.0250172035, -0.0082210835, -0.1343060977,
                            0.1321951487,  -0.1339298456, -0.4282029762, 0.3985403494,  0.9473701443,  0.3908900386,
                            -0.0244985608, 0.0106054427,  -0.0477819900, -0.0117137727, -0.0144162937, -0.0849549596,
                            0.0762809288,  -0.0691057140, -0.2830026071, 0.2496887722,  0.5600835479,  0.1883080295,
                            -0.0259485663, 0.0117916181,  -0.0521858885, -0.0125587872, -0.0044920837, -0.0845302793,
                            0.1289305599,  -0.0964379796, -0.2999785673, 0.2618039485,  0.6341857339,  0.2028740571,
                            -0.0472370949, 0.0171875817,  -0.0686733297, -0.0136492625, -0.0023433896, -0.1171828184,
                            0.1210728008,  -0.0865349326, -0.5083450251, 0.4135550861,  0.7801012275,  0.2168377834,
                            -0.0430675479, 0.0149046770,  -0.0715985807, -0.0186416077, -0.0119331347, -0.1108449866,
                            0.1383302769,  -0.1083490139, -0.4386500665, 0.3704371015,  0.8036295475,  0.2968752512},
        {10, 12},
        device
    );
    Tensor expected_w_ih_1_grad(
        std::vector<double>{0.1324171942,  -0.0579150429, 0.1543905480,  0.0249940433,  -0.2861421220, 0.5365868557,
                            -0.1725115996, 0.0797301856,  -1.8297146531, -0.9680420670, -1.4119574488, -2.0703977770,
                            -0.1039454478, 0.0490845451,  -0.1352704106, -0.0261917659, 0.2649799529,  -0.4320312245,
                            0.1292281164,  -0.0767126205, 1.4916940173,  0.8655806569,  1.2033163445,  1.7576122315,
                            0.0109052860,  -0.0045749979, 0.0170872677,  0.0049121545,  -0.0290104434, 0.0431604367,
                            -0.0117196849, 0.0151536947,  -0.1683007918, -0.0999355578, -0.1464328412, -0.2110079168,
                            -0.1021114453, 0.0487699643,  -0.1414166090, -0.0299584163, 0.2804760907,  -0.4226354361,
                            0.1094101684,  -0.1105559529, 1.4908292781,  0.8910144106,  1.2487762106,  1.7808540134,
                            0.0772631792,  -0.0361122271, 0.0787709140,  0.0025592557,  -0.1833008057, 0.3139452271,
                            -0.0726521156, 0.0776040459,  -0.9878695110, -0.5074792298, -0.7667759604, -1.0383495049,
                            0.0250076158,  -0.0128625117, 0.0321986602,  0.0028386982,  -0.0873807677, 0.1078270007,
                            -0.0040909547, 0.0632800180,  -0.3305214681, -0.1993363062, -0.3027156584, -0.3640361940,
                            0.0145992975,  -0.0105852356, 0.0275598697,  0.0028196062,  -0.0935329546, 0.0759321846,
                            0.0183634676,  0.0734209681,  -0.2077085765, -0.1782003540, -0.2428956709, -0.2575580398,
                            0.0249529425,  -0.0105613594, 0.0291185153,  0.0061714417,  -0.0390994197, 0.0987535802,
                            -0.0572576777, -0.0245095967, -0.3639240440, -0.1937522399, -0.2505719172, -0.4314127706},
        {8, 12},
        device
    );
    Tensor expected_w_ih_0_reverse_grad(
        std::vector<double>{0.0174217207,  -0.0055961200, -0.0581401859, 0.1384665035, -0.1545147068, 0.0785857409,
                            -0.0597477646, -0.0674034524, -0.3396286517, 0.6901531805, -0.9238481358, 1.3939482308,
                            0.0141739401,  -0.0088001385, -0.0735000855, 0.1616801937, -0.1327283521, 0.0610648147,
                            -0.0931832781, 0.1446890237,  -0.2778965530, 1.0099808281, -1.2487423943, 1.6411651307,
                            0.0110872699,  -0.0052296555, -0.0445479231, 0.0917788070, -0.1043686040, 0.0032495025,
                            -0.0356636065, 0.1055760134,  -0.2143039999, 0.6241422205, -0.7653869587, 0.9530226038,
                            0.0058739515,  -0.0054074888, -0.0406716848, 0.0900296491, -0.0408199042, 0.0382741331,
                            -0.0809329943, 0.1410481681,  -0.1148249790, 0.6785276074, -0.7515838052, 0.9278529849,
                            0.0085698207,  -0.0065142403, -0.0450558927, 0.1071182963, -0.0903860132, 0.0168603445,
                            0.0167037314,  0.1132156281,  -0.1753332422, 0.6070044300, -0.7766926849, 1.0305513170,
                            0.0151680519,  -0.0063713317, -0.0608064930, 0.1420309471, -0.1564831898, 0.0109490331,
                            0.0402328986,  0.1453041760,  -0.2946688108, 0.8132793979, -1.0655162461, 1.4505307204,
                            0.0081305698,  -0.0030006180, -0.0338140155, 0.0762324389, -0.0718443172, 0.0123038652,
                            -0.0094373263, 0.0670427117,  -0.1547753794, 0.4885131563, -0.6032766731, 0.7961541279,
                            0.0118615153,  -0.0028516558, -0.0354538629, 0.0910722516, -0.1057996263, 0.0225850011,
                            0.0285805974,  0.0087290127,  -0.2276912068, 0.4795367405, -0.6233551512, 0.9420655120,
                            0.0104750516,  -0.0052203738, -0.0502355050, 0.1176243339, -0.0850578450, 0.0533056426,
                            -0.0760141031, 0.0573444841,  -0.2012898713, 0.7388826253, -0.8880409469, 1.2182115308,
                            0.0125120753,  -0.0066511207, -0.0557076954, 0.1269865689, -0.1097183392, 0.0297234261,
                            0.0128558310,  0.1549072809,  -0.2434780283, 0.7771018841, -0.9907224317, 1.3182360234},
        {10, 12},
        device
    );
    Tensor expected_w_ih_1_reverse_grad(
        std::vector<double>{
            1.0600387591e-01,  6.6735464756e-02,  1.8434778378e-01,  9.7557344933e-02,  -1.1170509362e-01,
            2.8977599795e-01,  -1.5450793611e-01, -2.8238563107e-01, -2.2265324968e+00, -2.5986859270e+00,
            -2.1942840919e+00, -1.5306195376e+00, -9.9425743362e-02, -5.9904458777e-02, -1.7516376169e-01,
            -9.5980588041e-02, 9.3934066199e-02,  -2.7017720604e-01, 1.5818857782e-01,  2.5805130277e-01,
            1.9959652690e+00,  2.4241040338e+00,  2.0097229833e+00,  1.4147104522e+00,  1.5300032432e-02,
            9.1478239440e-03,  2.8788033776e-02,  1.4306839800e-02,  -1.4431688344e-02, 3.4295946289e-02,
            -1.6764984060e-02, -5.2403566089e-02, -2.7815232387e-01, -3.9339423970e-01, -3.0141085036e-01,
            -1.7569391913e-01, -1.0801960294e-01, -6.5456502047e-02, -1.9314753354e-01, -1.0294380747e-01,
            9.4869583053e-02,  -2.7046615300e-01, 1.5609794890e-01,  3.0806864886e-01,  2.1093352073e+00,
            2.6853302315e+00,  2.1654509121e+00,  1.4499374049e+00,  3.7948394859e-02,  2.8960249761e-02,
            6.0117488521e-02,  3.0254674133e-02,  -2.9500937473e-02, 8.4576332157e-02,  -4.7701024900e-02,
            -9.7265047690e-02, -9.5002410324e-01, -9.8261228361e-01, -8.6691913357e-01, -6.4732749812e-01,
            1.7893273512e-02,  1.4215434378e-02,  3.3664332675e-02,  1.4885805235e-02,  -9.5397359098e-03,
            2.1086621129e-02,  -2.9166696665e-03, -6.4306829553e-02, -3.9418093269e-01, -5.2428150067e-01,
            -4.1811066017e-01, -2.4720185866e-01, 1.5836417323e-02,  1.2138117018e-02,  3.2212086393e-02,
            1.5875592198e-02,  -7.3928200024e-04, 1.2018970756e-02,  -3.2392883969e-03, -5.4289761402e-02,
            -3.1947626828e-01, -4.8284527791e-01, -3.7177812828e-01, -2.2295047791e-01, 2.3404982624e-02,
            1.2375273588e-02,  3.8366304058e-02,  2.3057328710e-02,  -2.8711569449e-02, 8.1382673010e-02,
            -5.3267985174e-02, -4.4998805581e-02, -4.7163031878e-01, -5.1047208141e-01, -4.4461145848e-01,
            -3.5785199606e-01
        },
        {8, 12},
        device
    );

    Tensor expected_w_hh_0_grad(
        std::vector<double>{2.4961425963e-02,  -5.0373120464e-03, 2.1139206421e-02,  1.3222353120e-03,
                            -4.7376759819e-03, 2.3062618695e-02,  -5.1650822853e-02, 1.0891733965e-02,
                            1.2700905990e-01,  -5.2421591013e-02, -8.5581610690e-02, -6.4836304407e-03,
                            -1.6517017804e-02, 3.4553768263e-03,  -1.5505379028e-02, -1.0943168596e-03,
                            -2.4875103489e-03, -2.1486317692e-02, 3.2599948338e-02,  -8.5087692719e-03,
                            -8.5822954365e-02, 3.6541691144e-02,  6.1085200132e-02,  6.8170728595e-03,
                            1.7809034978e-03,  -2.8072408880e-04, 8.3126779664e-04,  -7.1930705265e-05,
                            -1.0955166908e-03, 5.7534566856e-04,  -3.0169652769e-03, -7.3795670929e-04,
                            8.4636164531e-03,  -2.9490070448e-03, -3.6564134617e-03, 6.8631520651e-04,
                            -1.6309390822e-02, 3.2398919518e-03,  -1.4005602705e-02, -7.0517401575e-04,
                            -2.4693386248e-03, -2.0492371986e-02, 2.9453913922e-02,  -4.5136840795e-03,
                            -8.4018769198e-02, 3.4573257371e-02,  5.5343832306e-02,  4.5032482317e-03},
        {4, 12},
        device
    );
    Tensor expected_w_hh_1_grad(
        std::vector<double>{0.0169855988,  -0.0075174420, 0.0342595619,  0.0129873341,  -0.0430196853, 0.0716044874,
                            -0.0385308143, -0.0041121813, -0.1277713105, -0.1059175940, -0.1422270628, -0.1458719635,
                            -0.0275773782, 0.0126307476,  -0.0523811607, -0.0219591549, 0.0725123233,  -0.1125730258,
                            0.0513044129,  -0.0045203602, 0.2039415281,  0.1630507371,  0.2285321238,  0.2291003990,
                            0.0047204251,  -0.0023666450, 0.0070695991,  0.0042837132,  -0.0120110293, 0.0169993011,
                            -0.0033990616, 0.0049859681,  -0.0327022795, -0.0232583753, -0.0365980495, -0.0345283345,
                            -0.0103114500, 0.0043230255,  -0.0236974082, -0.0069747236, 0.0286716044,  -0.0463957296,
                            0.0299657948,  0.0064352173,  0.0807626066,  0.0708674386,  0.0913427320,  0.0953832665},
        {4, 12},
        device
    );
    Tensor expected_w_hh_0_reverse_grad(
        std::vector<double>{-0.0017198516, 0.0006672158,  0.0045234105, -0.0087593530, 0.0152385046, -0.0017941526,
                            -0.0015364762, 0.0003941932,  0.0191314676, -0.0226500327, 0.0481938579, -0.0414766900,
                            -0.0014763440, -0.0004707758, 0.0018816677, -0.0045163556, 0.0137596043, 0.0029423265,
                            -0.0060319168, 0.0067493103,  0.0157998871, -0.0144198270, 0.0283396523, -0.0251187621,
                            -0.0013438759, -0.0004726502, 0.0024827212, -0.0084446824, 0.0184321828, 0.0011463047,
                            -0.0050428508, 0.0172713638,  0.0147731649, -0.0136176674, 0.0270568770, -0.0342137018,
                            -0.0018953123, 0.0010147719,  0.0060739166, -0.0139950527, 0.0202623171, -0.0063553750,
                            0.0027336083,  0.0119580907,  0.0214950726, -0.0262739771, 0.0558845012, -0.0567588030},
        {4, 12},
        device
    );
    Tensor expected_w_hh_1_reverse_grad(
        std::vector<double>{0.0071458703,  0.0068662371,  0.0102729000,  0.0046961691,  -0.0030295408, 0.0102839251,
                            -0.0054969757, -0.0166470148, -0.1027228589, -0.1047389752, -0.1120951539, -0.0956474894,
                            -0.0232856306, -0.0225027195, -0.0330386607, -0.0149529103, 0.0089317139,  -0.0313357535,
                            0.0173989155,  0.0544059003,  0.3347811558,  0.3409953976,  0.3618816150,  0.3091614347,
                            0.0104476197,  0.0102389843,  0.0146389034,  0.0064883843,  -0.0041045621, 0.0134364201,
                            -0.0070830058, -0.0240865090, -0.1509453785, -0.1529160638, -0.1619719164, -0.1383127165,
                            0.0154743551,  0.0152245861,  0.0227681877,  0.0099876502,  -0.0089686382, 0.0231138213,
                            -0.0083978942, -0.0380527244, -0.2216355393, -0.2283006664, -0.2466713851, -0.2030090429},
        {4, 12},
        device
    );

    Tensor expected_b_ih_0_grad(
        std::vector<double>{
            -0.0863079230,
            0.0371089685,
            -0.1546457671,
            -0.0422891505,
            -0.0262801334,
            -0.2756261766,
            0.1953261517,
            -0.2204495106,
            -0.9596978691,
            0.8578332328,
            1.8328651870,
            0.6465949038
        },
        {12},
        device
    );
    Tensor expected_b_ih_1_grad(
        std::vector<double>{
            -0.3951079843,
            0.1883122327,
            -0.4778922768,
            -0.0668027523,
            1.0189184022,
            -1.6252718178,
            0.4109896265,
            -0.3892800339,
            5.4320303455,
            3.0609903257,
            4.3885877455,
            6.1568084237
        },
        {12},
        device
    );
    Tensor expected_b_ih_0_reverse_grad(
        std::vector<double>{
            0.0275770610,
            -0.0138631082,
            -0.1183386053,
            0.2712739383,
            -0.2543671842,
            0.0978456325,
            -0.0891956770,
            0.1478536283,
            -0.5416998344,
            1.5770987323,
            -1.9960589719,
            2.7318853982
        },
        {12},
        device
    );
    Tensor expected_b_ih_1_reverse_grad(
        std::vector<double>{
            -0.3107489949,
            -0.2018678493,
            -0.5349746375,
            -0.2842646769,
            0.2637182845,
            -0.7686316664,
            0.4503461539,
            0.8343639040,
            6.5871369141,
            7.7790244717,
            6.4809680393,
            4.5697988598
        },
        {12},
        device
    );

    Tensor expected_b_hh_0_grad(
        std::vector<double>{
            -0.0863079230,
            0.0371089685,
            -0.1546457671,
            -0.0422891505,
            -0.0262801334,
            -0.2756261766,
            0.1953261517,
            -0.2204495106,
            -0.5243058527,
            0.3459744968,
            0.8513103769,
            0.2369989457
        },
        {12},
        device
    );
    Tensor expected_b_hh_1_grad(
        std::vector<double>{
            -0.3951079843,
            0.1883122327,
            -0.4778922768,
            -0.0668027523,
            1.0189184022,
            -1.6252718178,
            0.4109896265,
            -0.3892800339,
            2.3978181276,
            1.5196352651,
            2.3765139803,
            2.0339333434
        },
        {12},
        device
    );
    Tensor expected_b_hh_0_reverse_grad(
        std::vector<double>{
            0.0275770610,
            -0.0138631082,
            -0.1183386053,
            0.2712739383,
            -0.2543671842,
            0.0978456325,
            -0.0891956770,
            0.1478536283,
            -0.3072283044,
            0.9075025153,
            -1.5070670662,
            1.2472395927
        },
        {12},
        device
    );
    Tensor expected_b_hh_1_reverse_grad(
        std::vector<double>{
            -0.3107489949,
            -0.2018678493,
            -0.5349746375,
            -0.2842646769,
            0.2637182845,
            -0.7686316664,
            0.4503461539,
            0.8343639040,
            3.0120602684,
            3.8428298749,
            3.8821396225,
            2.8082192264
        },
        {12},
        device
    );

    auto close_options = CloseOptions().atol(1e-4).rtol(1e-4);
    auto output = gru.forward(x).output;
    output.backward(ones_like(output));
    CHECK(allclose(output, expected_output, close_options));

    CHECK(allclose(gru.weights_ih[0]->grad().value(), expected_w_ih_0_grad, close_options));
    CHECK(allclose(gru.weights_ih[1]->grad().value(), expected_w_ih_1_grad, close_options));
    CHECK(allclose(gru.weights_ih_reverse[0]->grad().value(), expected_w_ih_0_reverse_grad, close_options));
    CHECK(allclose(gru.weights_ih_reverse[1]->grad().value(), expected_w_ih_1_reverse_grad, close_options));

    CHECK(allclose(gru.weights_hh[0]->grad().value(), expected_w_hh_0_grad, close_options));
    CHECK(allclose(gru.weights_hh[1]->grad().value(), expected_w_hh_1_grad, close_options));
    CHECK(allclose(gru.weights_hh_reverse[0]->grad().value(), expected_w_hh_0_reverse_grad, close_options));
    CHECK(allclose(gru.weights_hh_reverse[1]->grad().value(), expected_w_hh_1_reverse_grad, close_options));

    CHECK(allclose(gru.biases_ih[0]->grad().value(), expected_b_ih_0_grad, close_options));
    CHECK(allclose(gru.biases_ih[1]->grad().value(), expected_b_ih_1_grad, close_options));
    CHECK(allclose(gru.biases_ih_reverse[0]->grad().value(), expected_b_ih_0_reverse_grad, close_options));
    CHECK(allclose(gru.biases_ih_reverse[1]->grad().value(), expected_b_ih_1_reverse_grad, close_options));

    CHECK(allclose(gru.biases_hh[0]->grad().value(), expected_b_hh_0_grad, close_options));
    CHECK(allclose(gru.biases_hh[1]->grad().value(), expected_b_hh_1_grad, close_options));
    CHECK(allclose(gru.biases_hh_reverse[0]->grad().value(), expected_b_hh_0_reverse_grad, close_options));
    CHECK(allclose(gru.biases_hh_reverse[1]->grad().value(), expected_b_hh_1_reverse_grad, close_options));
}
