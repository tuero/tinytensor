// test_layernorm.cpp
// Test LayerNorm module

#define DOCTEST_CONFIG_IMPLEMENT_WITH_MAIN
#include <tt/device.h>
#include <tt/exception.h>
#include <tt/index.h>
#include <tt/nn/layernorm.h>
#include <tt/scalar.h>
#include <tt/shape.h>
#include <tt/tensor.h>

#include "doctest.h"
#include "test_util.h"

#include <cmath>
#include <vector>

using namespace tinytensor;

// NOLINTNEXTLINE
TEST_CASE("LayerNorm 1") {
    auto device = kCPU;

    Tensor x1(
        std::vector<double>{
            0.9700530018, 0.7078198644, 0.4593829431, 0.9207476841, 0.6450241201, 0.7911478922, 0.1786061752,
            0.3511076244, 0.5813409198, 0.2882358921, 0.4528688489, 0.1767995262, 0.3552667583, 0.6219052487,
            0.4818484008, 0.4408004990, 0.4072815744, 0.2054385935, 0.6650381758, 0.7848739005, 0.2103664749,
            0.6767391209, 0.1097352602, 0.5237520594, 0.2260202029, 0.5582430754, 0.5875289618, 0.6819456857,
            0.7453761606, 0.2276556366, 0.8098922664, 0.6305903134, 0.1958881457, 0.1527262379, 0.4815065022,
            0.9175058125, 0.5720397102, 0.4808294232, 0.7960586083, 0.3679702043, 0.2721837106, 0.0414394867,
            0.7486882683, 0.3417558526, 0.5382250086, 0.4663654189, 0.8634864608, 0.0410593751, 0.9972603835,
            0.8796640992, 0.7629971687, 0.2558997318, 0.1896080775, 0.9877646698, 0.7796018768, 0.3618793465,
            0.5658438596, 0.7411996910, 0.0044629453, 0.5836046331, 0.5697132769, 0.0482853292, 0.1630045496,
            0.9986809627, 0.6006669758, 0.1491397202, 0.3941369121, 0.8634036173, 0.1111691826, 0.8095259533,
            0.7889851943, 0.7976543949, 0.4067139891, 0.7236211067, 0.0118146038, 0.2565920075, 0.1886534594,
            0.1625644490, 0.4951283841, 0.1543591922, 0.2295393374, 0.4106006232, 0.3740821919, 0.1829006983,
            0.3997668577, 0.5176780267, 0.6120128234, 0.3901567083, 0.5384221473, 0.1986132992, 0.4292197272,
            0.8564509594, 0.9220216976, 0.0381015975, 0.7036744426, 0.1759125699, 0.1784870876, 0.1802635979,
            0.6691781854, 0.6163473828, 0.1682727669, 0.9763201255, 0.6773539965, 0.5621401946, 0.4464305668,
            0.9702240925, 0.5018658142, 0.9718945689, 0.8711800058, 0.2299712563, 0.7127754446, 0.4449486630,
            0.5335603314, 0.1508773646, 0.6579348621, 0.0437534692, 0.4993554353, 0.4468499724, 0.7940168216,
            0.3046997015, 0.3207686709, 0.7123367945, 0.0592943337, 0.8919226622, 0.0551303000, 0.8933083891,
            0.3076751090, 0.6252239781, 0.0354067268, 0.0789453428, 0.6955946680, 0.1182951348, 0.4508924975,
            0.8822074377, 0.2881390352, 0.1074188003, 0.2181239288, 0.7552704663, 0.5075060468, 0.5449539286,
            0.1274333674, 0.7667131888, 0.6513552590, 0.6590377142
        },
        {4, 4, 3, 3},
        device,
        true
    );
    Tensor x2(
        std::vector<double>{
            0.0852954564, 0.5638234367, 0.2646637438, 0.1003915559, 0.7661793085, 0.6386622625, 0.0701283954,
            0.9221720875, 0.7855236570, 0.6659942469, 0.5833243270, 0.7208499264, 0.3892309243, 0.5183244419,
            0.9113936583, 0.6539964593, 0.3341261736, 0.8554093457, 0.7698793652, 0.3510038211, 0.8680567821,
            0.6852465776, 0.9904393029, 0.2350654336, 0.0206707716, 0.4975797364, 0.0829632232, 0.2841955848,
            0.5928841493, 0.9326344352, 0.4928948705, 0.5977506039, 0.2802381249, 0.7104876558, 0.6406901344,
            0.2061165732, 0.2936327458, 0.7877769710, 0.1641429420, 0.2044854128, 0.2702757202, 0.4022711177,
            0.9759692499, 0.1356347803, 0.2899102995, 0.8633511325, 0.5567461073, 0.7600084412, 0.3232751936,
            0.0746519897, 0.6000315915, 0.4596266605, 0.7451609042, 0.9220767428, 0.8437247545, 0.6852562370,
            0.5579561620, 0.1114592440, 0.6357629860, 0.8283317292, 0.5420369409, 0.7272442550, 0.3964049714,
            0.1711276422, 0.9142196689, 0.3828028272, 0.2141616199, 0.2050173073, 0.9841613323, 0.2842302977,
            0.2932578226, 0.1594795616, 0.3951129458, 0.3340495328, 0.8734566329, 0.9872415160, 0.1548266411,
            0.1885468063, 0.2140843513, 0.3999089648, 0.1824119949, 0.3173162728, 0.9759828965, 0.3597244209,
            0.2149778506, 0.7926840211, 0.0724898880, 0.8629250324, 0.2750570639, 0.5572374876, 0.8987212914,
            0.7558330204, 0.3001163703, 0.4024659228, 0.5835948880, 0.7343396223, 0.1762717948, 0.7052443861,
            0.5924197564, 0.4754887461, 0.1286247752, 0.1302735630, 0.9828385546, 0.3571115517, 0.6482177567,
            0.5392709374, 0.2948816882, 0.0046367790, 0.3861173377, 0.2631030524, 0.8180266464, 0.8491467234,
            0.8901818903, 0.0069961765, 0.0457135244, 0.3181430277, 0.2173360239, 0.4019985500, 0.6478851107,
            0.6760435148, 0.9890789190, 0.9931607172, 0.9832538145, 0.9680281552, 0.9803845942, 0.5653117087,
            0.9100374162, 0.0827367813, 0.5495420544, 0.2956831241, 0.5249294657, 0.2049472295, 0.9415401056,
            0.7668936187, 0.1573723357, 0.5417625895, 0.1055421088, 0.6363988849, 0.4114655367, 0.1090831634,
            0.1342324554, 0.3924816992, 0.7865848470, 0.7023881691
        },
        {4, 4, 3, 3},
        device,
        true
    );

    Tensor expected1(
        std::vector<double>{
            1.4110455775,  0.3454637525,  -0.6640572813, 1.2106938945,  0.0902938512,  0.6840663898,  -1.8049909701,
            -1.1040329948, -0.1684822192, -0.6979950997, 0.5386297731,  -1.5350388154, -0.1944990924, 1.8083306916,
            0.7563069344,  0.4479795055,  0.1962052752,  -1.3199191723, 0.8076616789,  1.3378235356,  -1.2038385952,
            0.8594275011,  -1.6490383197, 0.1826017483,  -1.1345853777, 0.3351924813,  0.4647553473,  0.5330020006,
            0.7680695161,  -1.1505552067, 1.0071602803,  0.3426837065,  -1.2682826109, -1.4282366781, -0.2098072083,
            1.4059662005,  0.4924245234,  0.0837699783,  1.4961089094,  -0.4218794857, -0.8510370654, -1.8848533042,
            1.2838729282,  -0.5393291104, 0.3409226263,  -0.3963804430, 0.7398725656,  -1.6132771087, 1.1226299775,
            0.7861604438,  0.4523500011,  -0.9985703170, -1.1882457148, 1.0954605955,  1.2900772750,  -0.2261215093,
            0.5142042438,  1.1506896597,  -1.5234283906, 0.5786701542,  0.5282489872,  -1.3643671947, -0.9479732253,
            1.2711324890,  -0.0392742880, -1.5258662046, -0.7192463591, 0.8257502762,  -1.6508790218, 0.6483654144,
            0.5807377665,  0.6092799274,  0.5645809039,  2.1257752935,  -1.3808304504, -0.1749720517, -0.5096609063,
            -0.6381844208, 1.0001408825,  -0.6786063622, -0.3082428886, 0.0581317539,  -0.2103145676, -1.6156862320,
            -0.0215070588, 0.8452557889,  1.5387091555,  -0.0921510910, 0.9977454407,  -1.5001831895, -0.1025266549,
            1.2553080546,  1.4637062652,  -1.3455859915, 0.7697507227,  -0.9075924470, -0.8994100641, -0.8937639241,
            0.6601140390,  -0.1457926813, -1.8562801608, 1.2283732445,  0.0870949791,  -0.3527241017, -0.7944359561,
            1.2051021471,  -0.5828165221, 1.2114790513,  1.5890986047,  -0.8919193361, 0.9761865716,  -0.0601109689,
            0.2827526294,  -1.1979559650, 0.7639928527,  -1.6124486036, 0.1504042153,  -0.1600086895, 0.9347397515,
            -0.6082622820, -0.5575907413, 0.6771717189,  -1.3821182663, 1.2434739138,  -1.3952490404, 1.2478436352,
            -0.2825435007, 0.8495017140,  -1.2531661328, -1.0979532298, 1.1003695663,  -0.9576732664, 0.2280190460,
            1.7656343917,  -0.3521885883, -1.5068047033, -1.0614532634, 1.0994130578,  0.1026910231,  0.2533386788,
            -1.4262888646, 1.1454455496,  0.6813765330,  0.7122819891
        },
        {4, 4, 3, 3},
        device,
        true
    );
    Tensor expected2(
        std::vector<double>{
            -1.1945678406, 0.3057051199,  -0.6322153710, -1.1472388006, 0.9401278818,  0.5403385611,  -1.2421193580,
            1.4291938464,  1.0007759612,  0.2198013823,  -0.2328397580, 0.5201517078,  -1.2955559098, -0.5887324716,
            1.5634324099,  0.1541101094,  -1.5972699700, 1.2569024999,  0.8178412939,  -0.4519905336, 1.1154686210,
            0.5612748533,  1.4864743344,  -0.8034606937, -1.4534035448, -0.0076419317, -1.2645623989, -1.0899479473,
            0.2990002391,  1.8277110420,  -0.1509028134, 0.3208969146,  -1.1077545891, 0.8281587365,  0.5141038868,
            -1.4412654692, -0.3548357916, 1.4355572311,  -0.8240057815, -0.6778361522, -0.4394634233, 0.0387848827,
            2.1174191769,  -0.9272971105, -0.3683230316, 1.0671186923,  -0.1273556061, 0.6645154126,  -1.0369134506,
            -2.0055017077, 0.0412763278,  -0.5057143203, 0.6066722598,  1.2959023924,  1.1637238161,  0.4310663543,
            -0.1574880869, -2.2218053635, 0.2022410951,  1.0925562740,  -0.2310884229, 0.6251921983,  -0.9043978645,
            -0.7643309375, 1.7071147156,  -0.0603216128, -0.6212044696, -0.6516174882, 1.9397333064,  -0.3881634425,
            -0.3581388473, -0.8030712242, -0.0664589254, -0.2768222169, 1.5814337752,  1.9734223876,  -0.8942445909,
            -0.7780787137, -0.6901019407, -0.0499366528, -0.7992131223, -0.5808544851, 1.6087792270,  -0.4398752591,
            -0.9210624918, 0.9994309126,  -1.3947413382, 1.2329361193,  -0.7213385859, 0.2167259012,  1.4695608091,
            0.8266429836,  -1.2238287293, -0.7633126123, 0.0516670892,  0.7299346345,  -1.7810605065, 0.5990222381,
            0.0913740936,  0.2778782874,  -0.9302108772, -0.9244683300, 2.0449220208,  -0.1344164964, 0.8794744852,
            0.5000246634,  -0.3511562854, -1.3620474678, -0.1092457858, -0.4875565969, 1.2190223948,  1.3147272274,
            1.4409243375,  -1.2751724395, -1.1561034123, -0.3182899328, -0.6283057923, -1.8461543407, -0.7072302343,
            -0.5768030764, 0.8731483436,  0.8920548604,  0.8461669913,  0.7756431271,  0.8328770247,  -1.0897026957,
            1.3524250151,  -1.3280872212, 0.1843946911,  -0.6381260952, 0.1046481730,  -0.9321167748, 1.4544959440,
            0.8886290444,  -1.0862627764, 0.4729965327,  -1.2856312046, 0.8545238141,  -0.0522974900, -1.2713554035,
            -1.1699657520, -0.1288310430, 1.4600001966,  1.1205603497
        },
        {4, 4, 3, 3},
        device,
        true
    );

    nn::LayerNorm bn({3, 3});

    Tensor res1 = bn.forward(x1);
    Tensor res2 = bn.forward(x2);
    CHECK(allclose(res1, expected1));
    CHECK(allclose(res2, expected2));
}

// NOLINTNEXTLINE
TEST_CASE("LayerNorm 2") {
    auto device = kCPU;

    Tensor x1(
        std::vector<double>{
            0.9700530018, 0.7078198644, 0.4593829431, 0.9207476841, 0.6450241201, 0.7911478922, 0.1786061752,
            0.3511076244, 0.5813409198, 0.2882358921, 0.4528688489, 0.1767995262, 0.3552667583, 0.6219052487,
            0.4818484008, 0.4408004990, 0.4072815744, 0.2054385935, 0.6650381758, 0.7848739005, 0.2103664749,
            0.6767391209, 0.1097352602, 0.5237520594, 0.2260202029, 0.5582430754, 0.5875289618, 0.6819456857,
            0.7453761606, 0.2276556366, 0.8098922664, 0.6305903134, 0.1958881457, 0.1527262379, 0.4815065022,
            0.9175058125, 0.5720397102, 0.4808294232, 0.7960586083, 0.3679702043, 0.2721837106, 0.0414394867,
            0.7486882683, 0.3417558526, 0.5382250086, 0.4663654189, 0.8634864608, 0.0410593751, 0.9972603835,
            0.8796640992, 0.7629971687, 0.2558997318, 0.1896080775, 0.9877646698, 0.7796018768, 0.3618793465,
            0.5658438596, 0.7411996910, 0.0044629453, 0.5836046331, 0.5697132769, 0.0482853292, 0.1630045496,
            0.9986809627, 0.6006669758, 0.1491397202, 0.3941369121, 0.8634036173, 0.1111691826, 0.8095259533,
            0.7889851943, 0.7976543949, 0.4067139891, 0.7236211067, 0.0118146038, 0.2565920075, 0.1886534594,
            0.1625644490, 0.4951283841, 0.1543591922, 0.2295393374, 0.4106006232, 0.3740821919, 0.1829006983,
            0.3997668577, 0.5176780267, 0.6120128234, 0.3901567083, 0.5384221473, 0.1986132992, 0.4292197272,
            0.8564509594, 0.9220216976, 0.0381015975, 0.7036744426, 0.1759125699, 0.1784870876, 0.1802635979,
            0.6691781854, 0.6163473828, 0.1682727669, 0.9763201255, 0.6773539965, 0.5621401946, 0.4464305668,
            0.9702240925, 0.5018658142, 0.9718945689, 0.8711800058, 0.2299712563, 0.7127754446, 0.4449486630,
            0.5335603314, 0.1508773646, 0.6579348621, 0.0437534692, 0.4993554353, 0.4468499724, 0.7940168216,
            0.3046997015, 0.3207686709, 0.7123367945, 0.0592943337, 0.8919226622, 0.0551303000, 0.8933083891,
            0.3076751090, 0.6252239781, 0.0354067268, 0.0789453428, 0.6955946680, 0.1182951348, 0.4508924975,
            0.8822074377, 0.2881390352, 0.1074188003, 0.2181239288, 0.7552704663, 0.5075060468, 0.5449539286,
            0.1274333674, 0.7667131888, 0.6513552590, 0.6590377142
        },
        {4, 4, 3, 3},
        device,
        true
    );
    Tensor x2(
        std::vector<double>{
            0.0852954564, 0.5638234367, 0.2646637438, 0.1003915559, 0.7661793085, 0.6386622625, 0.0701283954,
            0.9221720875, 0.7855236570, 0.6659942469, 0.5833243270, 0.7208499264, 0.3892309243, 0.5183244419,
            0.9113936583, 0.6539964593, 0.3341261736, 0.8554093457, 0.7698793652, 0.3510038211, 0.8680567821,
            0.6852465776, 0.9904393029, 0.2350654336, 0.0206707716, 0.4975797364, 0.0829632232, 0.2841955848,
            0.5928841493, 0.9326344352, 0.4928948705, 0.5977506039, 0.2802381249, 0.7104876558, 0.6406901344,
            0.2061165732, 0.2936327458, 0.7877769710, 0.1641429420, 0.2044854128, 0.2702757202, 0.4022711177,
            0.9759692499, 0.1356347803, 0.2899102995, 0.8633511325, 0.5567461073, 0.7600084412, 0.3232751936,
            0.0746519897, 0.6000315915, 0.4596266605, 0.7451609042, 0.9220767428, 0.8437247545, 0.6852562370,
            0.5579561620, 0.1114592440, 0.6357629860, 0.8283317292, 0.5420369409, 0.7272442550, 0.3964049714,
            0.1711276422, 0.9142196689, 0.3828028272, 0.2141616199, 0.2050173073, 0.9841613323, 0.2842302977,
            0.2932578226, 0.1594795616, 0.3951129458, 0.3340495328, 0.8734566329, 0.9872415160, 0.1548266411,
            0.1885468063, 0.2140843513, 0.3999089648, 0.1824119949, 0.3173162728, 0.9759828965, 0.3597244209,
            0.2149778506, 0.7926840211, 0.0724898880, 0.8629250324, 0.2750570639, 0.5572374876, 0.8987212914,
            0.7558330204, 0.3001163703, 0.4024659228, 0.5835948880, 0.7343396223, 0.1762717948, 0.7052443861,
            0.5924197564, 0.4754887461, 0.1286247752, 0.1302735630, 0.9828385546, 0.3571115517, 0.6482177567,
            0.5392709374, 0.2948816882, 0.0046367790, 0.3861173377, 0.2631030524, 0.8180266464, 0.8491467234,
            0.8901818903, 0.0069961765, 0.0457135244, 0.3181430277, 0.2173360239, 0.4019985500, 0.6478851107,
            0.6760435148, 0.9890789190, 0.9931607172, 0.9832538145, 0.9680281552, 0.9803845942, 0.5653117087,
            0.9100374162, 0.0827367813, 0.5495420544, 0.2956831241, 0.5249294657, 0.2049472295, 0.9415401056,
            0.7668936187, 0.1573723357, 0.5417625895, 0.1055421088, 0.6363988849, 0.4114655367, 0.1090831634,
            0.1342324554, 0.3924816992, 0.7865848470, 0.7023881691
        },
        {4, 4, 3, 3},
        device,
        true
    );

    Tensor expected1(
        std::vector<double>{
            1.9221349130,  0.8356207236,  -0.1937314124, 1.7178475075,  0.5754382468,  1.1808748950,  -1.3570776828,
            -0.6423500398, 0.3115787612,  -0.9028473586, -0.2207213493, -1.3645631966, -0.6251174425, 0.4796495067,
            -0.1006499706, -0.2707243103, -0.4096037350, -1.2459025527, 0.6583627607,  1.1548797782,  -1.2254847932,
            0.7068434488,  -1.6424314985, 0.0729700384,  -1.1606264852, 0.2158771425,  0.3372177614,  0.7284158807,
            0.9912282456,  -1.1538503703, 1.2585387204,  0.5156344556,  -1.2854730551, -1.4643063855, -0.1020665636,
            1.7044154159,  0.1518872374,  -0.1487032850, 0.8901587614,  -0.5206395287, -0.8363112925, -1.5967466454,
            0.7340461592,  -0.6070309428, 0.0404482850,  -0.1963705246, 1.1123724397,  -1.5979993322, 1.5532347002,
            1.1656870927,  0.7812022421,  -0.8899763983, -1.1084456482, 1.5219408446,  0.8359243356,  -0.5407124195,
            0.1314683348,  0.7093669762,  -1.7186056839, 0.1900003311,  0.1442202972,  -1.5741856443, -1.1961196223,
            1.5579163283,  0.2462305948,  -1.2418122349, -0.4344051288, 1.1120994227,  -1.3669470646, 0.9345414333,
            0.8668477809,  0.8954177989,  -0.1689413582, 0.9951718275,  -1.6195480375, -0.7203930883, -0.9699556741,
            -1.0657899398, 0.1558363361,  -1.0959307828, -0.8197672211, -0.1546643610, -0.2888096204, -0.9910876230,
            -0.1944606567, 0.2386692383,  0.5851946860,  -0.2297621724, 0.3148698127,  -0.9333696200, -0.0862697330,
            1.4831033833,  1.7239681565,  -1.5229865081, 0.9219005964,  -1.0167575178, -1.0073003934, -1.0007746357,
            0.7951835058,  0.6011170726,  -1.0448212467, 1.9234257020,  0.8252161841,  0.4019946830,  -0.0230481635,
            1.9010327928,  0.1805853267,  1.9071690499,  1.4767571192,  -0.8080720988, 0.9123116558,  -0.0420397256,
            0.2737116256,  -1.0899086064, 0.7168973458,  -1.4716248672, 0.1518287813,  -0.0352647602, 1.2018003317,
            -0.5417910550, -0.4845322439, 0.9107486069,  -1.4162478603, 1.5506697527,  -1.4310856273, 1.5556075353,
            -0.5311887389, 0.6003381387,  -1.5013669455, -1.3462251108, 0.8510911244,  -1.2060093784, -0.0208599669,
            1.5160513405,  -0.6008019376, -1.2447651921, -0.8502878669, 1.0637348348,  0.1808719834,  0.3143106094,
            -1.1734469704, 1.1045088676,  0.6934521427,  0.7208271561
        },
        {4, 4, 3, 3},
        device,
        true
    );
    Tensor expected2(
        std::vector<double>{
            -1.6028691763, 0.1231742598,  -0.9558903835, -1.5484177658, 0.8530689341,  0.3931168115,  -1.6575765439,
            1.4157326095,  0.9228437165,  0.4917028799,  0.1935136863,  0.6895665149,  -0.5065783825, -0.0409399500,
            1.3768549728,  0.4484270353,  -0.7053404134, 1.1749203749,  0.8664149847,  -0.6444629854, 1.2205394933,
            0.5611457557,  1.6619714585,  -1.0626510561, -1.8359694706, -0.1157657996, -1.6112815073, -0.8854393183,
            0.2279958257,  1.4534701449,  -0.1326640426, 0.2455490566,  -0.8997138182, 0.6521899559,  0.4004313156,
            -1.1670691728, -0.7098103791, 1.0451800130,  -1.1697031591, -1.0264238390, -0.7927646124, -0.3239730278,
            1.7135590495,  -1.2709520400, -0.7230309269, 1.3135873331,  0.2246565192,  0.9465579901,  -0.6045329956,
            -1.4875370087, 0.3783881728,  -0.1202705028, 0.8938258454,  1.5221557562,  1.2438827752,  0.6810699129,
            0.2289541195,  -1.3568132762, 0.5052909087,  1.1892132876,  0.1724158080,  0.8301935179,  -0.3448070878,
            -1.1448964709, 1.4942507671,  -0.3931161263, -0.9920580615, -1.0245347757, 1.7426538467,  -0.7432038809,
            -0.7111419468, -1.1862655054, -0.2572585431, -0.4711233993, 1.4180638624,  1.8165772515,  -1.0988229677,
            -0.9807234721, -0.8912822973, -0.2404612520, -1.0022096697, -0.5297289713, 1.7771457341,  -0.3812012022,
            -0.8881529584, 1.1351706834,  -1.3871943018, 1.3811786125,  -0.6777351044, 0.3105567845,  1.5065492956,
            1.0061059360,  -0.5899688840, -0.2315059148, 0.4028693718,  0.9308287401,  -1.0237147402, 0.8289273200,
            0.4337770646,  0.0242448672,  -1.1905908206, -1.1848162044, 1.8011565821,  -0.3903523595, 0.6292006538,
            0.2476318103,  -0.6083025227, -1.6248389845, -0.4664515250, -0.8523227758, 0.8883617372,  0.9859792052,
            1.1146983304,  -1.6556789088, -1.5342303192, -0.6796733630, -0.9958848059, -0.4166353332, 0.3546617118,
            0.4429890033,  1.4249185625,  1.4377223485,  1.4066463728,  1.3588865196,  1.3976462016,  0.0956454371,
            1.1769811506,  -1.4180957546, 0.0461791803,  -0.7501255960, -0.0310255960, -1.0347459803, 1.2757987971,
            0.7279676390,  -1.1839789230, 0.0217765523,  -1.3465599959, 0.3186317151,  -0.3869392859, -1.3354524147,
            -1.2565641072, -0.4464877938, 0.7897350906,  0.5256269235
        },
        {4, 4, 3, 3},
        device,
        true
    );

    nn::LayerNorm bn({4, 3, 3});

    Tensor res1 = bn.forward(x1);
    Tensor res2 = bn.forward(x2);
    CHECK(allclose(res1, expected1));
    CHECK(allclose(res2, expected2));
}
